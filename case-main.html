<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fresko Case System</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;touch-action:manipulation}
        html,body{width:100%;height:100%;background:#000;color:#fff;font-family:'Segoe UI',system-ui,sans-serif}
        .background{position:fixed;top:0;left:0;width:100%;height:100%;z-index:-2}
        #background-video{width:100%;height:100%;object-fit:cover;opacity:0.15}
        .header{position:fixed;top:0;left:0;right:0;height:60px;background:rgba(61,59,60,0.95);backdrop-filter:blur(10px);border-bottom:1px solid #444;z-index:1000;padding:0 20px;display:flex;align-items:center;justify-content:space-between}
        .logo{display:flex;align-items:center;gap:10px;font-size:20px;font-weight:bold;background:linear-gradient(45deg,#ff3838,#ff5757);-webkit-background-clip:text;background-clip:text;color:transparent}
        .logo-icon{font-size:24px}
        .user-info{display:flex;align-items:center;gap:15px}
        .user-balance{background:rgba(255,56,56,0.2);padding:5px 15px;border-radius:20px;border:1px solid rgba(255,56,56,0.5);font-size:14px}
        .user-name{font-size:14px;color:#aaa}
        .logout-btn{background:none;border:none;color:#aaa;font-size:20px;cursor:pointer;transition:all 0.3s}
        .logout-btn:hover{color:#ff3838}
        .main-content{padding:80px 20px 30px;max-width:1200px;margin:0 auto}
        .category-selector{display:flex;gap:15px;margin-bottom:30px;justify-content:center}
        .category-btn{flex:1;max-width:300px;height:60px;background:rgba(61,59,60,0.5);border:1px solid #444;border-radius:10px;color:#aaa;font-size:16px;font-weight:bold;cursor:pointer;transition:all 0.3s;display:flex;align-items:center;justify-content:center;gap:10px}
        .category-btn:hover{background:rgba(255,56,56,0.1);border-color:#ff3838}
        .category-btn.active{background:linear-gradient(145deg,#ff3838,#ff5757);color:white;border-color:#ff3838}
        .category-icon{font-size:20px}
        .content-section{display:none}
        .content-section.active{display:block}
        .admin-panel-btn{position:fixed;bottom:20px;right:20px;width:60px;height:60px;background:linear-gradient(145deg,#ff3838,#ff5757);border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;cursor:pointer;z-index:1000;font-size:24px;box-shadow:0 5px 15px rgba(255,56,56,0.3);transition:all 0.3s}
        .admin-panel-btn:hover{transform:scale(1.1);box-shadow:0 8px 20px rgba(255,56,56,0.4)}
        /* Стили для кейсов */
        .cases-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin-top:20px}
        .case-card{background:rgba(61,59,60,0.3);border-radius:15px;border:1px solid #444;padding:20px;transition:all 0.3s;position:relative}
        .case-card:hover{transform:translateY(-5px);box-shadow:0 10px 20px rgba(0,0,0,0.3);border-color:#ff3838}
        .case-image{width:100%;height:150px;object-fit:cover;border-radius:10px;margin-bottom:15px}
        .case-name{font-size:18px;font-weight:bold;margin-bottom:10px;color:#fff}
        .case-description{color:#aaa;font-size:14px;line-height:1.4;margin-bottom:15px;min-height:40px}
        .case-price{font-size:20px;font-weight:bold;color:#ff3838;margin-bottom:15px}
        .case-btn{width:100%;height:40px;background:linear-gradient(145deg,#ff3838,#ff5757);color:white;border:none;border-radius:10px;font-size:14px;font-weight:bold;cursor:pointer;transition:all 0.3s}
        .case-btn:hover{background:linear-gradient(145deg,#ff5757,#ff3838);transform:translateY(-2px)}
        .case-btn:disabled{opacity:0.5;cursor:not-allowed;transform:none}
        /* Стили для розыгрышей */
        .giveaways-container{display:flex;flex-direction:column;gap:25px;max-width:800px;margin:0 auto}
        .giveaway-card{background:rgba(61,59,60,0.3);border-radius:15px;border:1px solid #444;padding:25px;transition:all 0.3s}
        .giveaway-card:hover{transform:translateY(-5px);box-shadow:0 10px 20px rgba(0,0,0,0.3);border-color:#ff3838}
        .giveaway-image{width:100%;height:200px;object-fit:cover;border-radius:10px;margin-bottom:20px}
        .giveaway-title{font-size:22px;font-weight:bold;margin-bottom:10px;color:#fff}
        .giveaway-description{color:#aaa;font-size:15px;line-height:1.5;margin-bottom:20px}
        .giveaway-prize{background:rgba(255,56,56,0.1);padding:10px 15px;border-radius:10px;border:1px solid rgba(255,56,56,0.3);margin-bottom:20px}
        .prize-label{color:#aaa;font-size:14px;margin-bottom:5px}
        .prize-value{color:#ff3838;font-size:18px;font-weight:bold}
        .giveaway-info{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin-bottom:25px}
        .info-item{background:rgba(255,255,255,0.05);padding:15px;border-radius:10px;text-align:center}
        .info-label{color:#aaa;font-size:12px;margin-bottom:5px}
        .info-value{color:#fff;font-size:18px;font-weight:bold}
        .participate-btn{width:100%;height:50px;background:linear-gradient(145deg,#ff3838,#ff5757);color:white;border:none;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer;transition:all 0.3s;display:flex;align-items:center;justify-content:center;gap:10px}
        .participate-btn:hover{background:linear-gradient(145deg,#ff5757,#ff3838);transform:translateY(-2px)}
        .participate-btn:disabled{opacity:0.5;cursor:not-allowed;transform:none}
        /* Модальное окно */
        .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:2000;align-items:center;justify-content:center;padding:20px}
        .modal-content{background:rgba(61,59,60,0.95);border-radius:15px;border:1px solid #444;max-width:500px;width:100%;max-height:90vh;overflow-y:auto}
        .modal-header{padding:20px;border-bottom:1px solid #444;display:flex;justify-content:space-between;align-items:center}
        .modal-title{font-size:20px;font-weight:bold}
        .modal-close{background:none;border:none;color:#aaa;font-size:24px;cursor:pointer;transition:all 0.3s}
        .modal-close:hover{color:#ff3838}
        .modal-body{padding:20px}
        @media (max-width:768px){.cases-grid{grid-template-columns:1fr}.category-selector{flex-direction:column;align-items:center}.category-btn{max-width:100%}.giveaway-info{grid-template-columns:repeat(2,1fr)}}
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="background">
        <video id="background-video" autoplay loop muted playsinline>
            <source src="fon.mp4" type="video/mp4">
        </video>
    </div>
    
    <div class="header">
        <div class="logo">
            <i class="fas fa-briefcase logo-icon"></i>
            <span>Fresko Case</span>
        </div>
        
        <div class="user-info">
            <div class="user-name" id="userName"></div>
            <div class="user-balance" id="userBalance">
                <i class="fas fa-coins"></i>
                <span id="balanceAmount">0 ₽</span>
            </div>
            <button class="logout-btn" id="logoutBtn" title="Выйти">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </div>
    </div>
    
    <div class="main-content">
        <div class="category-selector">
            <button class="category-btn active" data-category="giveaways">
                <i class="fas fa-gift category-icon"></i>
                <span>Розыгрыши</span>
            </button>
            <button class="category-btn" data-category="cases">
                <i class="fas fa-box-open category-icon"></i>
                <span>Кейсы</span>
            </button>
        </div>
        
        <div class="content-section active" id="giveawaysSection">
            <div class="giveaways-container" id="giveawaysContainer">
                <div class="loading-text">Загрузка розыгрышей...</div>
            </div>
        </div>
        
        <div class="content-section" id="casesSection">
            <div class="cases-grid" id="casesContainer">
                <div class="loading-text">Загрузка кейсов...</div>
            </div>
        </div>
    </div>
    
    <button class="admin-panel-btn" id="adminPanelBtn" style="display: none;">
        <i class="fas fa-cog"></i>
    </button>
    
    <!-- Модальное окно для покупки кейса -->
    <div class="modal" id="purchaseModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Покупка кейса</div>
                <button class="modal-close" id="closePurchaseModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="purchaseModalContent">
                    <!-- Контент будет загружен динамически -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно для участия в розыгрыше -->
    <div class="modal" id="giveawayModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Участие в розыгрыше</div>
                <button class="modal-close" id="closeGiveawayModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="giveawayModalContent">
                    <!-- Контент будет загружен динамически -->
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://gcxujsoqiywkiruzrqdg.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdjeHVqc29xaXl3a2lydXpycWRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5MDY0MDIsImV4cCI6MjA4MTQ4MjQwMn0.B4HCviU2uMbUgtBILaFc5p0V6Pvj-0G8eKS-AEMu8as';
        
        let supabaseClient = null;
        let currentUser = null;
        let currentCategory = 'giveaways';

        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Case система загружена');
            
            // Проверяем авторизацию
            await checkAuth();
            
            try {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                console.log('Supabase подключен');
            } catch (error) {
                console.error('Ошибка Supabase:', error);
                showError('Ошибка подключения к базе данных');
                return;
            }
            
            // Загружаем данные пользователя
            await loadUserData();
            
            // Настройка интерфейса
            setupUI();
            
            // Загружаем данные в зависимости от категории
            loadCategoryData(currentCategory);
        });

        async function checkAuth() {
            const userData = localStorage.getItem('fresko_user');
            const token = localStorage.getItem('fresko_auth_token');
            
            if (!userData || !token) {
                window.location.href = 'case-login.html';
                return;
            }
            
            try {
                currentUser = JSON.parse(userData);
                
                // Проверяем токен через Supabase Auth
                const { data: { user }, error } = await supabaseClient?.auth.getUser(token);
                if (error) {
                    throw error;
                }
                
                // Обновляем данные пользователя
                const { data: freshUser, error: userError } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();
                
                if (!userError && freshUser) {
                    currentUser = freshUser;
                    localStorage.setItem('fresko_user', JSON.stringify(freshUser));
                }
                
            } catch (error) {
                console.error('Ошибка проверки авторизации:', error);
                localStorage.removeItem('fresko_user');
                localStorage.removeItem('fresko_auth_token');
                window.location.href = 'case-login.html';
            }
        }

        async function loadUserData() {
            if (!currentUser) return;
            
            // Обновляем отображение данных пользователя
            document.getElementById('userName').textContent = currentUser.username;
            document.getElementById('balanceAmount').textContent = `${currentUser.balance || 0} ₽`;
            
            // Показываем кнопку админ-панели если пользователь админ
            if (currentUser.role === 'admin') {
                document.getElementById('adminPanelBtn').style.display = 'flex';
            }
        }

        function setupUI() {
            // Настройка переключения категорий
            const categoryBtns = document.querySelectorAll('.category-btn');
            categoryBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const category = this.getAttribute('data-category');
                    switchCategory(category);
                });
            });
            
            // Кнопка выхода
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            // Кнопка админ-панели
            document.getElementById('adminPanelBtn').addEventListener('click', function() {
                window.location.href = 'admin-panel.html';
            });
            
            // Модальные окна
            document.getElementById('closePurchaseModal').addEventListener('click', function() {
                document.getElementById('purchaseModal').style.display = 'none';
            });
            
            document.getElementById('closeGiveawayModal').addEventListener('click', function() {
                document.getElementById('giveawayModal').style.display = 'none';
            });
            
            // Закрытие модальных окон при клике вне контента
            window.addEventListener('click', function(event) {
                const purchaseModal = document.getElementById('purchaseModal');
                const giveawayModal = document.getElementById('giveawayModal');
                
                if (event.target === purchaseModal) {
                    purchaseModal.style.display = 'none';
                }
                if (event.target === giveawayModal) {
                    giveawayModal.style.display = 'none';
                }
            });
        }

        function switchCategory(category) {
            if (currentCategory === category) return;
            
            // Обновляем активные кнопки
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-category') === category) {
                    btn.classList.add('active');
                }
            });
            
            // Обновляем активные секции
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.getElementById(`${category}Section`).classList.add('active');
            currentCategory = category;
            
            // Загружаем данные для новой категории
            loadCategoryData(category);
        }

        async function loadCategoryData(category) {
            if (category === 'giveaways') {
                await loadGiveaways();
            } else if (category === 'cases') {
                await loadCases();
            }
        }

        async function loadGiveaways() {
            const container = document.getElementById('giveawaysContainer');
            container.innerHTML = '<div class="loading-text">Загрузка розыгрышей...</div>';
            
            try {
                // Получаем активные розыгрыши
                const { data: giveaways, error } = await supabaseClient
                    .from('giveaways')
                    .select('*')
                    .eq('is_active', true)
                    .eq('is_finished', false)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                if (!giveaways || giveaways.length === 0) {
                    container.innerHTML = `
                        <div class="no-data">
                            <i class="fas fa-gift" style="font-size:50px;color:#666;margin-bottom:20px"></i>
                            <div style="color:#666;font-size:16px">Активных розыгрышей пока нет</div>
                        </div>
                    `;
                    return;
                }
                
                // Для каждого розыгрыша проверяем, участвует ли пользователь
                const giveawaysWithParticipation = await Promise.all(
                    giveaways.map(async giveaway => {
                        const { data: participation, error: partError } = await supabaseClient
                            .from('giveaway_participants')
                            .select('id')
                            .eq('giveaway_id', giveaway.id)
                            .eq('user_id', currentUser.id)
                            .single();
                        
                        return {
                            ...giveaway,
                            is_participating: !partError && participation
                        };
                    })
                );
                
                // Отображаем розыгрыши
                container.innerHTML = giveawaysWithParticipation.map(giveaway => `
                    <div class="giveaway-card" data-id="${giveaway.id}">
                        ${giveaway.image_url ? `
                            <img src="${giveaway.image_url}" alt="${giveaway.title}" class="giveaway-image" onerror="this.src='https://via.placeholder.com/800x400/3D3B3C/ffffff?text=Fresko+Giveaway'">
                        ` : `
                            <div class="giveaway-image" style="background:#3D3B3C;display:flex;align-items:center;justify-content:center;color:#888">
                                <i class="fas fa-gift" style="font-size:60px"></i>
                            </div>
                        `}
                        
                        <div class="giveaway-title">${giveaway.title}</div>
                        <div class="giveaway-description">${giveaway.description || 'Описание розыгрыша'}</div>
                        
                        <div class="giveaway-prize">
                            <div class="prize-label">Приз:</div>
                            <div class="prize-value">${giveaway.prize}</div>
                        </div>
                        
                        <div class="giveaway-info">
                            <div class="info-item">
                                <div class="info-label">Победителей</div>
                                <div class="info-value">${giveaway.winners_count}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Участников</div>
                                <div class="info-value">${giveaway.participants_count}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Максимум</div>
                                <div class="info-value">${giveaway.max_participants || '∞'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">До конца</div>
                                <div class="info-value" id="timer-${giveaway.id}"></div>
                            </div>
                        </div>
                        
                        <button class="participate-btn" 
                                onclick="participateInGiveaway('${giveaway.id}')"
                                ${giveaway.is_participating ? 'disabled' : ''}
                                ${giveaway.max_participants && giveaway.participants_count >= giveaway.max_participants ? 'disabled' : ''}>
                            ${giveaway.is_participating ? 
                                '<i class="fas fa-check"></i><span>Вы участвуете</span>' : 
                                '<i class="fas fa-ticket-alt"></i><span>Участвовать</span>'}
                        </button>
                    </div>
                `).join('');
                
                // Запускаем таймеры обратного отсчета
                giveaways.forEach(giveaway => {
                    updateCountdown(giveaway.id, new Date(giveaway.end_date));
                    setInterval(() => updateCountdown(giveaway.id, new Date(giveaway.end_date)), 1000);
                });
                
            } catch (error) {
                console.error('Ошибка загрузки розыгрышей:', error);
                container.innerHTML = '<div class="error-text">Ошибка загрузки розыгрышей</div>';
            }
        }

        async function loadCases() {
            const container = document.getElementById('casesContainer');
            container.innerHTML = '<div class="loading-text">Загрузка кейсов...</div>';
            
            try {
                // Получаем активные кейсы
                const { data: cases, error } = await supabaseClient
                    .from('cases')
                    .select('*')
                    .eq('is_active', true)
                    .order('order_index', { ascending: true });
                
                if (error) throw error;
                
                if (!cases || cases.length === 0) {
                    container.innerHTML = `
                        <div class="no-data">
                            <i class="fas fa-box-open" style="font-size:50px;color:#666;margin-bottom:20px"></i>
                            <div style="color:#666;font-size:16px">Кейсы временно недоступны</div>
                        </div>
                    `;
                    return;
                }
                
                // Отображаем кейсы
                container.innerHTML = cases.map(caseItem => `
                    <div class="case-card">
                        ${caseItem.image_url ? `
                            <img src="${caseItem.image_url}" alt="${caseItem.name}" class="case-image" onerror="this.src='https://via.placeholder.com/400x300/3D3B3C/ffffff?text=${encodeURIComponent(caseItem.name)}'">
                        ` : `
                            <div class="case-image" style="background:#3D3B3C;display:flex;align-items:center;justify-content:center;color:#888">
                                <i class="fas fa-box-open" style="font-size:60px"></i>
                            </div>
                        `}
                        
                        <div class="case-name">${caseItem.name}</div>
                        <div class="case-description">${caseItem.description || 'Откройте и получите приз!'}</div>
                        <div class="case-price">${caseItem.price} ₽</div>
                        
                        <button class="case-btn" onclick="openPurchaseModal('${caseItem.id}')"
                                ${currentUser.balance < caseItem.price ? 'disabled' : ''}>
                            ${currentUser.balance < caseItem.price ? 
                                'Недостаточно средств' : 
                                'Купить кейс'}
                        </button>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Ошибка загрузки кейсов:', error);
                container.innerHTML = '<div class="error-text">Ошибка загрузки кейсов</div>';
            }
        }

        function updateCountdown(giveawayId, endDate) {
            const timerElement = document.getElementById(`timer-${giveawayId}`);
            if (!timerElement) return;
            
            const now = new Date();
            const timeLeft = endDate - now;
            
            if (timeLeft <= 0) {
                timerElement.textContent = 'Завершен';
                return;
            }
            
            const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
            const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
            
            if (days > 0) {
                timerElement.textContent = `${days}д ${hours}ч`;
            } else if (hours > 0) {
                timerElement.textContent = `${hours}ч ${minutes}м`;
            } else {
                timerElement.textContent = `${minutes}м ${seconds}с`;
            }
        }

        async function participateInGiveaway(giveawayId) {
            try {
                // Проверяем, не участвует ли уже пользователь
                const { data: existing, error: checkError } = await supabaseClient
                    .from('giveaway_participants')
                    .select('id')
                    .eq('giveaway_id', giveawayId)
                    .eq('user_id', currentUser.id)
                    .single();
                
                if (!checkError && existing) {
                    showError('Вы уже участвуете в этом розыгрыше');
                    return;
                }
                
                // Проверяем лимит участников
                const { data: giveaway, error: giveawayError } = await supabaseClient
                    .from('giveaways')
                    .select('max_participants, participants_count')
                    .eq('id', giveawayId)
                    .single();
                
                if (giveawayError) throw giveawayError;
                
                if (giveaway.max_participants && giveaway.participants_count >= giveaway.max_participants) {
                    showError('Достигнут лимит участников');
                    return;
                }
                
                // Добавляем участника
                const { error: insertError } = await supabaseClient
                    .from('giveaway_participants')
                    .insert({
                        giveaway_id: giveawayId,
                        user_id: currentUser.id
                    });
                
                if (insertError) throw insertError;
                
                // Увеличиваем счетчик участников
                await supabaseClient
                    .from('giveaways')
                    .update({ participants_count: giveaway.participants_count + 1 })
                    .eq('id', giveawayId);
                
                showSuccess('Вы успешно присоединились к розыгрышу!');
                
                // Обновляем список розыгрышей
                await loadGiveaways();
                
            } catch (error) {
                console.error('Ошибка участия в розыгрыше:', error);
                showError('Ошибка участия в розыгрыше');
            }
        }

        async function openPurchaseModal(caseId) {
            try {
                // Получаем информацию о кейсе
                const { data: caseItem, error } = await supabaseClient
                    .from('cases')
                    .select('*')
                    .eq('id', caseId)
                    .single();
                
                if (error) throw error;
                
                if (!caseItem) {
                    showError('Кейс не найден');
                    return;
                }
                
                // Проверяем баланс пользователя
                if (currentUser.balance < caseItem.price) {
                    showError('Недостаточно средств на балансе');
                    return;
                }
                
                // Заполняем модальное окно
                const modalContent = document.getElementById('purchaseModalContent');
                modalContent.innerHTML = `
                    <div style="text-align:center">
                        <div style="font-size:24px;font-weight:bold;margin-bottom:20px">${caseItem.name}</div>
                        
                        ${caseItem.image_url ? `
                            <img src="${caseItem.image_url}" alt="${caseItem.name}" style="width:100%;max-height:200px;object-fit:cover;border-radius:10px;margin-bottom:20px">
                        ` : ''}
                        
                        <div style="color:#aaa;margin-bottom:20px">${caseItem.description || ''}</div>
                        
                        <div style="font-size:28px;color:#ff3838;font-weight:bold;margin-bottom:30px">
                            ${caseItem.price} ₽
                        </div>
                        
                        <div style="display:flex;gap:15px;justify-content:center">
                            <button id="confirmPurchase" style="flex:1;height:50px;background:linear-gradient(145deg,#4CAF50,#45a049);color:white;border:none;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer">
                                Купить
                            </button>
                            <button id="cancelPurchase" style="flex:1;height:50px;background:#666;color:white;border:none;border-radius:10px;font-size:16px;cursor:pointer">
                                Отмена
                            </button>
                        </div>
                    </div>
                `;
                
                // Показываем модальное окно
                document.getElementById('purchaseModal').style.display = 'flex';
                
                // Настройка кнопок
                document.getElementById('confirmPurchase').addEventListener('click', async () => {
                    await purchaseCase(caseId, caseItem.price);
                });
                
                document.getElementById('cancelPurchase').addEventListener('click', () => {
                    document.getElementById('purchaseModal').style.display = 'none';
                });
                
            } catch (error) {
                console.error('Ошибка открытия модального окна:', error);
                showError('Ошибка загрузки информации о кейсе');
            }
        }

        async function purchaseCase(caseId, price) {
            try {
                // Проверяем баланс
                if (currentUser.balance < price) {
                    showError('Недостаточно средств');
                    return;
                }
                
                // Списываем деньги с баланса
                const newBalance = currentUser.balance - price;
                const { error: updateError } = await supabaseClient
                    .from('users')
                    .update({ balance: newBalance })
                    .eq('id', currentUser.id);
                
                if (updateError) throw updateError;
                
                // Создаем запись о покупке
                const { error: purchaseError } = await supabaseClient
                    .from('case_purchases')
                    .insert({
                        case_id: caseId,
                        user_id: currentUser.id,
                        amount: price
                    });
                
                if (purchaseError) throw purchaseError;
                
                // Обновляем данные пользователя
                currentUser.balance = newBalance;
                localStorage.setItem('fresko_user', JSON.stringify(currentUser));
                
                // Обновляем отображение баланса
                document.getElementById('balanceAmount').textContent = `${newBalance} ₽`;
                
                // Закрываем модальное окно
                document.getElementById('purchaseModal').style.display = 'none';
                
                showSuccess('Кейс успешно куплен!');
                
                // Обновляем список кейсов
                await loadCases();
                
            } catch (error) {
                console.error('Ошибка покупки кейса:', error);
                showError('Ошибка при покупке кейса');
            }
        }

        function logout() {
            if (confirm('Вы уверены, что хотите выйти?')) {
                localStorage.removeItem('fresko_user');
                localStorage.removeItem('fresko_auth_token');
                window.location.href = 'case-login.html';
            }
        }

        function showError(message) {
            // Можно реализовать красивое уведомление
            alert(`Ошибка: ${message}`);
        }

        function showSuccess(message) {
            // Можно реализовать красивое уведомление
            alert(`Успех: ${message}`);
        }

        // Экспортируем функции для использования в HTML
        window.participateInGiveaway = participateInGiveaway;
        window.openPurchaseModal = openPurchaseModal;
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</body>
</html>