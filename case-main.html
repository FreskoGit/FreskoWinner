<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fresko Case System</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;touch-action:manipulation}
        html,body{width:100%;height:100%;background:#000;color:#fff;font-family:'Segoe UI',system-ui,sans-serif}
        .background{position:fixed;top:0;left:0;width:100%;height:100%;z-index:-2}
        #background-video{width:100%;height:100%;object-fit:cover;opacity:0.15}
        .header{position:fixed;top:0;left:0;right:0;height:60px;background:rgba(61,59,60,0.95);backdrop-filter:blur(10px);border-bottom:1px solid #444;z-index:1000;padding:0 20px;display:flex;align-items:center;justify-content:space-between}
        .logo{display:flex;align-items:center;gap:10px;font-size:20px;font-weight:bold;background:linear-gradient(45deg,#ff3838,#ff5757);-webkit-background-clip:text;background-clip:text;color:transparent}
        .logo-icon{font-size:24px}
        .user-info{display:flex;align-items:center;gap:15px}
        .user-balance{background:rgba(255,56,56,0.2);padding:5px 15px;border-radius:20px;border:1px solid rgba(255,56,56,0.5);font-size:14px}
        .user-name{font-size:14px;color:#aaa}
        .logout-btn{background:none;border:none;color:#aaa;font-size:20px;cursor:pointer;transition:all 0.3s}
        .logout-btn:hover{color:#ff3838}
        .main-content{padding:80px 20px 30px;max-width:1200px;margin:0 auto}
        .category-selector{display:flex;gap:15px;margin-bottom:30px;justify-content:center}
        .category-btn{flex:1;max-width:300px;height:60px;background:rgba(61,59,60,0.5);border:1px solid #444;border-radius:10px;color:#aaa;font-size:16px;font-weight:bold;cursor:pointer;transition:all 0.3s;display:flex;align-items:center;justify-content:center;gap:10px}
        .category-btn:hover{background:rgba(255,56,56,0.1);border-color:#ff3838}
        .category-btn.active{background:linear-gradient(145deg,#ff3838,#ff5757);color:white;border-color:#ff3838}
        .category-icon{font-size:20px}
        .content-section{display:none}
        .content-section.active{display:block}
        .admin-panel-btn{position:fixed;bottom:20px;right:20px;width:60px;height:60px;background:linear-gradient(145deg,#ff3838,#ff5757);border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;cursor:pointer;z-index:1000;font-size:24px;box-shadow:0 5px 15px rgba(255,56,56,0.3);transition:all 0.3s}
        .admin-panel-btn:hover{transform:scale(1.1);box-shadow:0 8px 20px rgba(255,56,56,0.4)}
        .admin-panel-btn.hidden{display:none}
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–µ–π—Å–æ–≤ */
        .cases-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin-top:20px}
        .case-card{background:rgba(61,59,60,0.3);border-radius:15px;border:1px solid #444;padding:20px;transition:all 0.3s;position:relative}
        .case-card:hover{transform:translateY(-5px);box-shadow:0 10px 20px rgba(0,0,0,0.3);border-color:#ff3838}
        .case-image{width:100%;height:150px;object-fit:cover;border-radius:10px;margin-bottom:15px}
        .case-name{font-size:18px;font-weight:bold;margin-bottom:10px;color:#fff}
        .case-description{color:#aaa;font-size:14px;line-height:1.4;margin-bottom:15px;min-height:40px}
        .case-price{font-size:20px;font-weight:bold;color:#ff3838;margin-bottom:15px}
        .case-btn{width:100%;height:40px;background:linear-gradient(145deg,#ff3838,#ff5757);color:white;border:none;border-radius:10px;font-size:14px;font-weight:bold;cursor:pointer;transition:all 0.3s}
        .case-btn:hover{background:linear-gradient(145deg,#ff5757,#ff3838);transform:translateY(-2px)}
        .case-btn:disabled{opacity:0.5;cursor:not-allowed;transform:none}
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π */
        .giveaways-container{display:flex;flex-direction:column;gap:25px;max-width:800px;margin:0 auto}
        .giveaway-card{background:rgba(61,59,60,0.3);border-radius:15px;border:1px solid #444;padding:25px;transition:all 0.3s}
        .giveaway-card:hover{transform:translateY(-5px);box-shadow:0 10px 20px rgba(0,0,0,0.3);border-color:#ff3838}
        .giveaway-image{width:100%;height:200px;object-fit:cover;border-radius:10px;margin-bottom:20px}
        .giveaway-title{font-size:22px;font-weight:bold;margin-bottom:10px;color:#fff}
        .giveaway-description{color:#aaa;font-size:15px;line-height:1.5;margin-bottom:20px}
        .giveaway-prize{background:rgba(255,56,56,0.1);padding:10px 15px;border-radius:10px;border:1px solid rgba(255,56,56,0.3);margin-bottom:20px}
        .prize-label{color:#aaa;font-size:14px;margin-bottom:5px}
        .prize-value{color:#ff3838;font-size:18px;font-weight:bold}
        .giveaway-info{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin-bottom:25px}
        .info-item{background:rgba(255,255,255,0.05);padding:15px;border-radius:10px;text-align:center}
        .info-label{color:#aaa;font-size:12px;margin-bottom:5px}
        .info-value{color:#fff;font-size:18px;font-weight:bold}
        .participate-btn{width:100%;height:50px;background:linear-gradient(145deg,#ff3838,#ff5757);color:white;border:none;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer;transition:all 0.3s;display:flex;align-items:center;justify-content:center;gap:10px}
        .participate-btn:hover{background:linear-gradient(145deg,#ff5757,#ff3838);transform:translateY(-2px)}
        .participate-btn:disabled{opacity:0.5;cursor:not-allowed;transform:none}
        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
        .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:2000;align-items:center;justify-content:center;padding:20px}
        .modal-content{background:rgba(61,59,60,0.95);border-radius:15px;border:1px solid #444;max-width:500px;width:100%;max-height:90vh;overflow-y:auto}
        .modal-header{padding:20px;border-bottom:1px solid #444;display:flex;justify-content:space-between;align-items:center}
        .modal-title{font-size:20px;font-weight:bold}
        .modal-close{background:none;border:none;color:#aaa;font-size:24px;cursor:pointer;transition:all 0.3s}
        .modal-close:hover{color:#ff3838}
        .modal-body{padding:20px}
        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .notification{position:fixed;top:20px;right:20px;padding:15px 20px;border-radius:10px;color:white;z-index:9999;animation:slideIn 0.3s ease;max-width:400px;box-shadow:0 5px 15px rgba(0,0,0,0.3);display:flex;align-items:center;gap:10px}
        .notification.success{background:linear-gradient(145deg,#28a745,#218838)}
        .notification.error{background:linear-gradient(145deg,#dc3545,#c82333)}
        .notification.info{background:linear-gradient(145deg,#17a2b8,#138496)}
        .notification.warning{background:linear-gradient(145deg,#ffc107,#e0a800)}
        .notification-icon{font-size:20px}
        .notification-close{margin-left:auto;background:none;border:none;color:white;cursor:pointer}
        @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
        /* –ó–∞–≥—Ä—É–∑–∫–∞ */
        .loading-container{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px;gap:20px}
        .loading-spinner{width:50px;height:50px;border:3px solid rgba(255,56,56,0.3);border-radius:50%;border-top-color:#ff3838;animation:spin 1s linear infinite}
        .loading-text{color:#aaa;font-size:16px}
        @keyframes spin{to{transform:rotate(360deg)}}
        @media (max-width:768px){.cases-grid{grid-template-columns:1fr}.category-selector{flex-direction:column;align-items:center}.category-btn{max-width:100%}.giveaway-info{grid-template-columns:repeat(2,1fr)}}
        @media (max-width:480px){.user-info{gap:10px}.user-name{font-size:12px}.user-balance{font-size:12px;padding:4px 10px}}
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="background">
        <video id="background-video" autoplay loop muted playsinline>
            <source src="fon.mp4" type="video/mp4">
        </video>
    </div>
    
    <div class="header">
        <div class="logo">
            <i class="fas fa-briefcase logo-icon"></i>
            <span>Fresko Case</span>
        </div>
        
        <div class="user-info">
            <div class="user-name" id="userName">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <div class="user-balance" id="userBalance">
                <i class="fas fa-coins"></i>
                <span id="balanceAmount">0 ‚ÇΩ</span>
            </div>
            <button class="logout-btn" id="logoutBtn" title="–í—ã–π—Ç–∏">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </div>
    </div>
    
    <div class="main-content">
        <div class="category-selector">
            <button class="category-btn active" data-category="giveaways">
                <i class="fas fa-gift category-icon"></i>
                <span>–†–æ–∑—ã–≥—Ä—ã—à–∏</span>
            </button>
            <button class="category-btn" data-category="cases">
                <i class="fas fa-box-open category-icon"></i>
                <span>–ö–µ–π—Å—ã</span>
            </button>
        </div>
        
        <div class="content-section active" id="giveawaysSection">
            <div class="giveaways-container" id="giveawaysContainer">
                <div class="loading-container">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π...</div>
                </div>
            </div>
        </div>
        
        <div class="content-section" id="casesSection">
            <div class="cases-grid" id="casesContainer">
                <div class="loading-container">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–µ–π—Å–æ–≤...</div>
                </div>
            </div>
        </div>
    </div>
    
    <button class="admin-panel-btn hidden" id="adminPanelBtn">
        <i class="fas fa-cog"></i>
    </button>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–∫—É–ø–∫–∏ –∫–µ–π—Å–∞ -->
    <div class="modal" id="purchaseModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">–ü–æ–∫—É–ø–∫–∞ –∫–µ–π—Å–∞</div>
                <button class="modal-close" id="closePurchaseModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="purchaseModalContent">
                    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —É—á–∞—Å—Ç–∏—è –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–µ -->
    <div class="modal" id="giveawayModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">–£—á–∞—Å—Ç–∏–µ –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–µ</div>
                <button class="modal-close" id="closeGiveawayModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="giveawayModalContent">
                    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
        const SUPABASE_URL = 'https://gcxujsoqiywkiruzrqdg.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdjeHVqc29xaXl3a2lydXpycWRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5MDY0MDIsImV4cCI6MjA4MTQ4MjQwMn0.B4HCviU2uMbUgtBILaFc5p0V6Pvj-0G8eKS-AEMu8as';
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let supabaseClient = null;
        let currentUser = null;
        let currentCategory = 'giveaways';
        let securitySystem = null;
        let userSessionValid = false;
        let autoRefreshInterval = null;

        // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================

        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Fresko Case System –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–∞–≥—Ä—É–∑–∫–µ
            showNotification('–°–∏—Å—Ç–µ–º–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...', 'info');
            
            try {
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Supabase
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
                    auth: {
                        persistSession: true,
                        autoRefreshToken: true,
                        detectSessionInUrl: false,
                        storage: window.localStorage,
                        storageKey: 'fresko_supabase_auth'
                    }
                });
                
                console.log('‚úÖ Supabase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
                const authResult = await checkAuth();
                
                if (!authResult) {
                    showNotification('–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è', 'error');
                    setTimeout(() => {
                        window.location.href = 'case-login.html';
                    }, 2000);
                    return;
                }
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–∏—Å—Ç–µ–º—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
                if (typeof SecuritySystem !== 'undefined') {
                    securitySystem = new SecuritySystem();
                    window.securitySystem = securitySystem;
                    console.log('‚úÖ –°–∏—Å—Ç–µ–º–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
                }
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                await loadUserData();
                
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                setupUI();
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ–∫—É—â–µ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                await loadCategoryData(currentCategory);
                
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                setupAutoRefresh();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∏
                checkActiveGiveaways();
                
                showNotification('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Fresko Case System!', 'success');
                
            } catch (error) {
                console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∏—Å—Ç–µ–º—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.', 'error');
            }
        });

        // ==================== –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ====================

        async function checkAuth() {
            try {
                console.log('üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Å—Å–∏—é Supabase
                const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
                
                if (sessionError) {
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏:', sessionError);
                    return false;
                }
                
                if (!session) {
                    console.log('–°–µ—Å—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ä—ã–µ —Ç–æ–∫–µ–Ω—ã –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                    const oldToken = localStorage.getItem('fresko_auth_token');
                    const oldUser = localStorage.getItem('fresko_user');
                    
                    if (oldToken && oldUser) {
                        console.log('–ù–∞–π–¥–µ–Ω —Å—Ç–∞—Ä—ã–π —Ç–æ–∫–µ–Ω, –ø—Ä–æ–±—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å...');
                        try {
                            // –ü—Ä–æ–±—É–µ–º –≤–æ–π—Ç–∏ —Å –ø–æ–º–æ—â—å—é —Å—Ç–∞—Ä–æ–≥–æ —Ç–æ–∫–µ–Ω–∞
                            const { data: { user }, error: userError } = await supabaseClient.auth.getUser(oldToken);
                            
                            if (!userError && user) {
                                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                                const { data: userData, error: userDataError } = await supabaseClient
                                    .from('users')
                                    .select('*')
                                    .eq('id', user.id)
                                    .single();
                                
                                if (!userDataError && userData) {
                                    console.log('‚úÖ –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥ –ø–æ —Å—Ç–∞—Ä–æ–º—É —Ç–æ–∫–µ–Ω—É');
                                    currentUser = userData;
                                    userSessionValid = true;
                                    
                                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
                                    localStorage.setItem('fresko_user', JSON.stringify(userData));
                                    localStorage.setItem('fresko_auth_token', oldToken);
                                    
                                    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é
                                    await supabaseClient.auth.setSession({
                                        access_token: oldToken,
                                        refresh_token: localStorage.getItem('fresko_refresh_token') || ''
                                    });
                                    
                                    return true;
                                }
                            }
                        } catch (oldTokenError) {
                            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–π —Ç–æ–∫–µ–Ω:', oldTokenError);
                        }
                    }
                    
                    return false;
                }
                
                console.log('‚úÖ –°–µ—Å—Å–∏—è –Ω–∞–π–¥–µ–Ω–∞:', session.user.email);
                
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –Ω–∞—à–µ–π —Ç–∞–±–ª–∏—Ü—ã
                const { data: userData, error: userError } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('id', session.user.id)
                    .single();
                
                if (userError) {
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', userError);
                    return false;
                }
                
                if (!userData) {
                    console.error('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö');
                    return false;
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                currentUser = userData;
                userSessionValid = true;
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                localStorage.setItem('fresko_user', JSON.stringify(userData));
                localStorage.setItem('fresko_auth_token', session.access_token);
                if (session.refresh_token) {
                    localStorage.setItem('fresko_refresh_token', session.refresh_token);
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤—Ö–æ–¥–∞
                await updateLastLogin();
                
                console.log('‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞');
                return true;
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', error);
                return false;
            }
        }

        async function updateLastLogin() {
            try {
                await supabaseClient
                    .from('users')
                    .update({ last_login: new Date().toISOString() })
                    .eq('id', currentUser.id);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –≤—Ö–æ–¥–∞:', error);
            }
        }

        // ==================== –î–ê–ù–ù–´–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ====================

        async function loadUserData() {
            if (!currentUser || !userSessionValid) return;
            
            try {
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –±–∞–∑—ã
                const { data: freshData, error } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();
                
                if (!error && freshData) {
                    currentUser = freshData;
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                    localStorage.setItem('fresko_user', JSON.stringify(freshData));
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                    updateUserDisplay();
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
            }
        }

        function updateUserDisplay() {
            if (!currentUser) return;
            
            try {
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const userNameElement = document.getElementById('userName');
                if (userNameElement) {
                    userNameElement.textContent = currentUser.username;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å
                const balanceElement = document.getElementById('balanceAmount');
                if (balanceElement) {
                    balanceElement.textContent = `${formatCurrency(currentUser.balance || 0)} ‚ÇΩ`;
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω
                const adminBtn = document.getElementById('adminPanelBtn');
                if (adminBtn) {
                    if (currentUser.role === 'admin' || currentUser.role === 'moderator') {
                        adminBtn.classList.remove('hidden');
                    } else {
                        adminBtn.classList.add('hidden');
                    }
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
            }
        }

        // ==================== –ò–ù–¢–ï–†–§–ï–ô–° ====================

        function setupUI() {
            // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
            const categoryBtns = document.querySelectorAll('.category-btn');
            categoryBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const category = this.getAttribute('data-category');
                    switchCategory(category);
                });
            });
            
            // –ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', logout);
            }
            
            // –ö–Ω–æ–ø–∫–∞ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
            const adminBtn = document.getElementById('adminPanelBtn');
            if (adminBtn) {
                adminBtn.addEventListener('click', function() {
                    if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'moderator')) {
                        window.location.href = 'admin-panel.html';
                    } else {
                        showNotification('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω', 'error');
                    }
                });
            }
            
            // –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
            const closePurchaseModal = document.getElementById('closePurchaseModal');
            if (closePurchaseModal) {
                closePurchaseModal.addEventListener('click', function() {
                    document.getElementById('purchaseModal').style.display = 'none';
                });
            }
            
            const closeGiveawayModal = document.getElementById('closeGiveawayModal');
            if (closeGiveawayModal) {
                closeGiveawayModal.addEventListener('click', function() {
                    document.getElementById('giveawayModal').style.display = 'none';
                });
            }
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
            window.addEventListener('click', function(event) {
                const purchaseModal = document.getElementById('purchaseModal');
                const giveawayModal = document.getElementById('giveawayModal');
                
                if (event.target === purchaseModal) {
                    purchaseModal.style.display = 'none';
                }
                if (event.target === giveawayModal) {
                    giveawayModal.style.display = 'none';
                }
            });
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ –Ω–∞ –æ–∫–Ω–µ
            window.addEventListener('focus', async function() {
                await loadUserData();
            });
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Å—Å–∏–∏ –ø—Ä–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden) {
                    checkSessionValidity();
                }
            });
            
            console.log('‚úÖ –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–∞—Å—Ç—Ä–æ–µ–Ω');
        }

        async function checkSessionValidity() {
            try {
                const { data: { session }, error } = await supabaseClient.auth.getSession();
                
                if (error || !session) {
                    showNotification('–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.', 'warning');
                    setTimeout(() => {
                        window.location.href = 'case-login.html';
                    }, 3000);
                    return false;
                }
                
                return true;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–µ—Å—Å–∏–∏:', error);
                return false;
            }
        }

        // ==================== –ö–ê–¢–ï–ì–û–†–ò–ò ====================

        function switchCategory(category) {
            if (currentCategory === category) return;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-category') === category) {
                    btn.classList.add('active');
                }
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ–∫—Ü–∏–∏
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            const sectionElement = document.getElementById(`${category}Section`);
            if (sectionElement) {
                sectionElement.classList.add('active');
            }
            
            currentCategory = category;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            loadCategoryData(category);
        }

        async function loadCategoryData(category) {
            try {
                if (category === 'giveaways') {
                    await loadGiveaways();
                } else if (category === 'cases') {
                    await loadCases();
                }
            } catch (error) {
                console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ${category}:`, error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö', 'error');
            }
        }

        // ==================== –†–û–ó–´–ì–†–´–®–ò ====================

        async function loadGiveaways() {
            const container = document.getElementById('giveawaysContainer');
            if (!container) return;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            container.innerHTML = `
                <div class="loading-container">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π...</div>
                </div>
            `;
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∏
                const { data: giveaways, error } = await supabaseClient
                    .from('giveaways')
                    .select('*')
                    .eq('is_active', true)
                    .eq('is_finished', false)
                    .order('end_date', { ascending: true })
                    .limit(20);
                
                if (error) throw error;
                
                if (!giveaways || giveaways.length === 0) {
                    container.innerHTML = `
                        <div class="no-data" style="text-align:center;padding:40px">
                            <i class="fas fa-gift" style="font-size:50px;color:#666;margin-bottom:20px"></i>
                            <div style="color:#666;font-size:16px">–ê–∫—Ç–∏–≤–Ω—ã—Ö —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π –ø–æ–∫–∞ –Ω–µ—Ç</div>
                            <div style="color:#888;font-size:14px;margin-top:10px">–°–ª–µ–¥–∏—Ç–µ –∑–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏!</div>
                        </div>
                    `;
                    return;
                }
                
                // –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–æ–∑—ã–≥—Ä—ã—à–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º, —É—á–∞—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                const giveawaysWithParticipation = await Promise.all(
                    giveaways.map(async giveaway => {
                        const { data: participation, error: partError } = await supabaseClient
                            .from('giveaway_participants')
                            .select('id')
                            .eq('giveaway_id', giveaway.id)
                            .eq('user_id', currentUser.id)
                            .single();
                        
                        return {
                            ...giveaway,
                            is_participating: !partError && participation,
                            can_participate: !giveaway.is_finished && 
                                           (giveaway.max_participants === null || 
                                            giveaway.participants_count < giveaway.max_participants)
                        };
                    })
                );
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–æ–∑—ã–≥—Ä—ã—à–∏
                container.innerHTML = giveawaysWithParticipation.map(giveaway => `
                    <div class="giveaway-card" data-id="${giveaway.id}">
                        ${giveaway.image_url ? `
                            <img src="${giveaway.image_url}" alt="${giveaway.title}" class="giveaway-image" 
                                 onerror="this.src='https://via.placeholder.com/800x400/3D3B3C/ffffff?text=Fresko+Giveaway'">
                        ` : `
                            <div class="giveaway-image" style="background:linear-gradient(145deg,#3D3B3C,#2a2829);display:flex;align-items:center;justify-content:center;color:#888">
                                <i class="fas fa-gift" style="font-size:60px"></i>
                            </div>
                        `}
                        
                        <div class="giveaway-title">${escapeHtml(giveaway.title)}</div>
                        <div class="giveaway-description">${escapeHtml(giveaway.description || '–û–ø–∏—Å–∞–Ω–∏–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∞')}</div>
                        
                        <div class="giveaway-prize">
                            <div class="prize-label">–ü—Ä–∏–∑:</div>
                            <div class="prize-value">${escapeHtml(giveaway.prize)}</div>
                        </div>
                        
                        <div class="giveaway-info">
                            <div class="info-item">
                                <div class="info-label">–ü–æ–±–µ–¥–∏—Ç–µ–ª–µ–π</div>
                                <div class="info-value">${giveaway.winners_count}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>
                                <div class="info-value">${giveaway.participants_count}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">–ú–∞–∫—Å–∏–º—É–º</div>
                                <div class="info-value">${giveaway.max_participants || '‚àû'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">–î–æ –∫–æ–Ω—Ü–∞</div>
                                <div class="info-value" id="timer-${giveaway.id}">
                                    ${formatTimeRemaining(new Date(giveaway.end_date))}
                                </div>
                            </div>
                        </div>
                        
                        <button class="participate-btn" 
                                onclick="participateInGiveaway('${giveaway.id}')"
                                ${giveaway.is_participating ? 'disabled' : ''}
                                ${!giveaway.can_participate ? 'disabled' : ''}
                                title="${giveaway.is_participating ? '–í—ã —É–∂–µ —É—á–∞—Å—Ç–≤—É–µ—Ç–µ' : giveaway.can_participate ? '–£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å' : '–†–æ–∑—ã–≥—Ä—ã—à –∑–∞–ø–æ–ª–Ω–µ–Ω'}">
                            ${giveaway.is_participating ? 
                                '<i class="fas fa-check"></i><span>–í—ã —É—á–∞—Å—Ç–≤—É–µ—Ç–µ</span>' : 
                                giveaway.can_participate ?
                                '<i class="fas fa-ticket-alt"></i><span>–£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å</span>' :
                                '<i class="fas fa-ban"></i><span>–ó–∞–ø–æ–ª–Ω–µ–Ω</span>'}
                        </button>
                    </div>
                `).join('');
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä—ã –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á–µ—Ç–∞
                giveaways.forEach(giveaway => {
                    updateCountdown(giveaway.id, new Date(giveaway.end_date));
                    const intervalId = setInterval(() => {
                        const result = updateCountdown(giveaway.id, new Date(giveaway.end_date));
                        if (result === 'expired') {
                            clearInterval(intervalId);
                            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
                            setTimeout(() => loadGiveaways(), 2000);
                        }
                    }, 1000);
                });
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π:', error);
                container.innerHTML = `
                    <div class="error-text" style="text-align:center;padding:40px;color:#ff3838">
                        <i class="fas fa-exclamation-triangle" style="font-size:40px;margin-bottom:20px"></i>
                        <div>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π</div>
                        <button onclick="loadGiveaways()" style="margin-top:20px;padding:10px 20px;background:#ff3838;color:white;border:none;border-radius:5px;cursor:pointer">
                            –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                        </button>
                    </div>
                `;
            }
        }

        async function checkActiveGiveaways() {
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∏—Å—Ç–µ–∫–ª–∏ –ª–∏ —Ä–æ–∑—ã–≥—Ä—ã—à–∏
                const { data: expiredGiveaways, error } = await supabaseClient
                    .from('giveaways')
                    .select('id, title')
                    .eq('is_active', true)
                    .eq('is_finished', false)
                    .lt('end_date', new Date().toISOString());
                
                if (!error && expiredGiveaways && expiredGiveaways.length > 0) {
                    console.log(`–ù–∞–π–¥–µ–Ω–æ ${expiredGiveaways.length} –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π`);
                    
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≤–µ—Ä—à–∞–µ–º —Ä–æ–∑—ã–≥—Ä—ã—à–∏
                    for (const giveaway of expiredGiveaways) {
                        await supabaseClient
                            .from('giveaways')
                            .update({ 
                                is_finished: true,
                                finished_at: new Date().toISOString()
                            })
                            .eq('id', giveaway.id);
                    }
                    
                    // –ï—Å–ª–∏ –º—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π, –æ–±–Ω–æ–≤–ª—è–µ–º –∏—Ö
                    if (currentCategory === 'giveaways') {
                        setTimeout(() => loadGiveaways(), 1000);
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π:', error);
            }
        }

        async function participateInGiveaway(giveawayId) {
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Å—Å–∏—é
                if (!await checkSessionValidity()) {
                    return;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º rate limit
                if (securitySystem) {
                    const rateLimit = securitySystem.checkRateLimit('giveaway_participation', 5, 60000);
                    if (!rateLimit.allowed) {
                        showNotification(`–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ ${rateLimit.retryAfter} —Å–µ–∫—É–Ω–¥.`, 'error');
                        return;
                    }
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                const { data: existing, error: checkError } = await supabaseClient
                    .from('giveaway_participants')
                    .select('id')
                    .eq('giveaway_id', giveawayId)
                    .eq('user_id', currentUser.id)
                    .single();
                
                if (!checkError && existing) {
                    showNotification('–í—ã —É–∂–µ —É—á–∞—Å—Ç–≤—É–µ—Ç–µ –≤ —ç—Ç–æ–º —Ä–æ–∑—ã–≥—Ä—ã—à–µ', 'warning');
                    return;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
                const { data: giveaway, error: giveawayError } = await supabaseClient
                    .from('giveaways')
                    .select('max_participants, participants_count, title, is_finished')
                    .eq('id', giveawayId)
                    .single();
                
                if (giveawayError) throw giveawayError;
                
                if (giveaway.is_finished) {
                    showNotification('–≠—Ç–æ—Ç —Ä–æ–∑—ã–≥—Ä—ã—à —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω', 'error');
                    return;
                }
                
                if (giveaway.max_participants && giveaway.participants_count >= giveaway.max_participants) {
                    showNotification('–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤', 'error');
                    return;
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞
                const { error: insertError } = await supabaseClient
                    .from('giveaway_participants')
                    .insert({
                        giveaway_id: giveawayId,
                        user_id: currentUser.id
                    });
                
                if (insertError) {
                    if (insertError.code === '23505') { // Unique violation
                        showNotification('–í—ã —É–∂–µ —É—á–∞—Å—Ç–≤—É–µ—Ç–µ –≤ —ç—Ç–æ–º —Ä–æ–∑—ã–≥—Ä—ã—à–µ', 'warning');
                        return;
                    }
                    throw insertError;
                }
                
                // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
                await supabaseClient
                    .from('giveaways')
                    .update({ participants_count: giveaway.participants_count + 1 })
                    .eq('id', giveawayId);
                
                showNotification(`–í—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ —Ä–æ–∑—ã–≥—Ä—ã—à—É "${giveaway.title}"!`, 'success');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
                await loadGiveaways();
                
                // –õ–æ–≥–∏—Ä—É–µ–º —É—á–∞—Å—Ç–∏–µ
                logUserAction('giveaway_participation', {
                    giveaway_id: giveawayId,
                    giveaway_title: giveaway.title
                });
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —É—á–∞—Å—Ç–∏—è –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–µ:', error);
                showNotification('–û—à–∏–±–∫–∞ —É—á–∞—Å—Ç–∏—è –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–µ', 'error');
            }
        }

        // ==================== –ö–ï–ô–°–´ ====================

        async function loadCases() {
            const container = document.getElementById('casesContainer');
            if (!container) return;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            container.innerHTML = `
                <div class="loading-container">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–µ–π—Å–æ–≤...</div>
                </div>
            `;
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–µ–π—Å—ã
                const { data: cases, error } = await supabaseClient
                    .from('cases')
                    .select('*')
                    .eq('is_active', true)
                    .order('order_index', { ascending: true })
                    .limit(50);
                
                if (error) throw error;
                
                if (!cases || cases.length === 0) {
                    container.innerHTML = `
                        <div class="no-data" style="text-align:center;padding:40px">
                            <i class="fas fa-box-open" style="font-size:50px;color:#666;margin-bottom:20px"></i>
                            <div style="color:#666;font-size:16px">–ö–µ–π—Å—ã –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã</div>
                            <div style="color:#888;font-size:14px;margin-top:10px">–ó–∞–≥–ª—è–Ω–∏—Ç–µ –ø–æ–∑–∂–µ!</div>
                        </div>
                    `;
                    return;
                }
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∫–µ–π—Å—ã
                container.innerHTML = cases.map(caseItem => `
                    <div class="case-card" data-id="${caseItem.id}">
                        ${caseItem.image_url ? `
                            <img src="${caseItem.image_url}" alt="${caseItem.name}" class="case-image" 
                                 onerror="this.src='https://via.placeholder.com/400x300/3D3B3C/ffffff?text=${encodeURIComponent(caseItem.name)}'">
                        ` : `
                            <div class="case-image" style="background:linear-gradient(145deg,#3D3B3C,#2a2829);display:flex;align-items:center;justify-content:center;color:#888">
                                <i class="fas fa-box-open" style="font-size:60px"></i>
                            </div>
                        `}
                        
                        <div class="case-name">${escapeHtml(caseItem.name)}</div>
                        <div class="case-description">${escapeHtml(caseItem.description || '–û—Ç–∫—Ä–æ–π—Ç–µ –∏ –ø–æ–ª—É—á–∏—Ç–µ –ø—Ä–∏–∑!')}</div>
                        <div class="case-price">${formatCurrency(caseItem.price)} ‚ÇΩ</div>
                        
                        <button class="case-btn" onclick="openPurchaseModal('${caseItem.id}')"
                                ${currentUser.balance < caseItem.price ? 'disabled' : ''}
                                title="${currentUser.balance < caseItem.price ? '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤' : '–ö—É–ø–∏—Ç—å –∫–µ–π—Å'}">
                            ${currentUser.balance < caseItem.price ? 
                                '<i class="fas fa-lock"></i> –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤' : 
                                '<i class="fas fa-shopping-cart"></i> –ö—É–ø–∏—Ç—å –∫–µ–π—Å'}
                        </button>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–µ–π—Å–æ–≤:', error);
                container.innerHTML = `
                    <div class="error-text" style="text-align:center;padding:40px;color:#ff3838">
                        <i class="fas fa-exclamation-triangle" style="font-size:40px;margin-bottom:20px"></i>
                        <div>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–µ–π—Å–æ–≤</div>
                        <button onclick="loadCases()" style="margin-top:20px;padding:10px 20px;background:#ff3838;color:white;border:none;border-radius:5px;cursor:pointer">
                            –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                        </button>
                    </div>
                `;
            }
        }

        async function openPurchaseModal(caseId) {
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Å—Å–∏—é
                if (!await checkSessionValidity()) {
                    return;
                }
                
                // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–µ–π—Å–µ
                const { data: caseItem, error } = await supabaseClient
                    .from('cases')
                    .select('*')
                    .eq('id', caseId)
                    .single();
                
                if (error) throw error;
                
                if (!caseItem) {
                    showNotification('–ö–µ–π—Å –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                    return;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∫–µ–π—Å–∞
                if (!caseItem.is_active) {
                    showNotification('–≠—Ç–æ—Ç –∫–µ–π—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω', 'error');
                    return;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                if (currentUser.balance < caseItem.price) {
                    showNotification('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ', 'error');
                    return;
                }
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                const modalContent = document.getElementById('purchaseModalContent');
                modalContent.innerHTML = `
                    <div style="text-align:center">
                        <div style="font-size:24px;font-weight:bold;margin-bottom:20px;color:#fff">${escapeHtml(caseItem.name)}</div>
                        
                        ${caseItem.image_url ? `
                            <img src="${caseItem.image_url}" alt="${caseItem.name}" 
                                 style="width:100%;max-height:200px;object-fit:cover;border-radius:10px;margin-bottom:20px"
                                 onerror="this.style.display='none'">
                        ` : ''}
                        
                        <div style="color:#aaa;margin-bottom:20px;text-align:left">${escapeHtml(caseItem.description || '')}</div>
                        
                        <div style="background:rgba(255,56,56,0.1);padding:15px;border-radius:10px;margin-bottom:30px">
                            <div style="color:#aaa;font-size:14px;margin-bottom:5px">–°—Ç–æ–∏–º–æ—Å—Ç—å:</div>
                            <div style="font-size:28px;color:#ff3838;font-weight:bold">${formatCurrency(caseItem.price)} ‚ÇΩ</div>
                        </div>
                        
                        <div style="background:rgba(59,130,246,0.1);padding:15px;border-radius:10px;margin-bottom:30px">
                            <div style="color:#aaa;font-size:14px;margin-bottom:5px">–í–∞—à –±–∞–ª–∞–Ω—Å:</div>
                            <div style="font-size:20px;color:#3b82f6;font-weight:bold">${formatCurrency(currentUser.balance)} ‚ÇΩ</div>
                            <div style="color:#${currentUser.balance >= caseItem.price ? '4CAF50' : 'ff3838'};font-size:14px;margin-top:5px">
                                –ü–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏: ${formatCurrency(currentUser.balance - caseItem.price)} ‚ÇΩ
                            </div>
                        </div>
                        
                        <div style="display:flex;gap:15px;justify-content:center">
                            <button id="confirmPurchase" style="flex:1;height:50px;background:linear-gradient(145deg,#4CAF50,#45a049);color:white;border:none;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer;transition:all 0.3s">
                                <i class="fas fa-check"></i> –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
                            </button>
                            <button id="cancelPurchase" style="flex:1;height:50px;background:#666;color:white;border:none;border-radius:10px;font-size:16px;cursor:pointer;transition:all 0.3s">
                                <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∞
                            </button>
                        </div>
                    </div>
                `;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                document.getElementById('purchaseModal').style.display = 'flex';
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–Ω–æ–ø–æ–∫
                document.getElementById('confirmPurchase').addEventListener('click', async () => {
                    await purchaseCase(caseId, caseItem.price, caseItem.name);
                });
                
                document.getElementById('cancelPurchase').addEventListener('click', () => {
                    document.getElementById('purchaseModal').style.display = 'none';
                });
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–µ–π—Å–µ', 'error');
            }
        }

        async function purchaseCase(caseId, price, caseName) {
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Å—Å–∏—é
                if (!await checkSessionValidity()) {
                    return;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å
                if (currentUser.balance < price) {
                    showNotification('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤', 'error');
                    document.getElementById('purchaseModal').style.display = 'none';
                    return;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º rate limit
                if (securitySystem) {
                    const rateLimit = securitySystem.checkRateLimit('case_purchase', 3, 30000);
                    if (!rateLimit.allowed) {
                        showNotification(`–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–∫—É–ø–æ–∫. –ü–æ–¥–æ–∂–¥–∏—Ç–µ ${rateLimit.retryAfter} —Å–µ–∫—É–Ω–¥.`, 'error');
                        return;
                    }
                }
                
                // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
                const confirmBtn = document.getElementById('confirmPurchase');
                if (confirmBtn) {
                    confirmBtn.disabled = true;
                    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –û–±—Ä–∞–±–æ—Ç–∫–∞...';
                }
                
                // –°–ø–∏—Å—ã–≤–∞–µ–º –¥–µ–Ω—å–≥–∏ —Å –±–∞–ª–∞–Ω—Å–∞
                const newBalance = currentUser.balance - price;
                const { error: updateError } = await supabaseClient
                    .from('users')
                    .update({ balance: newBalance })
                    .eq('id', currentUser.id);
                
                if (updateError) throw updateError;
                
                // –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –æ –ø–æ–∫—É–ø–∫–µ
                const { error: purchaseError } = await supabaseClient
                    .from('case_purchases')
                    .insert({
                        case_id: caseId,
                        user_id: currentUser.id,
                        amount: price,
                        items_received: [] // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –≤—ã–¥–∞—á–∏ –ø—Ä–µ–¥–º–µ—Ç–æ–≤
                    });
                
                if (purchaseError) throw purchaseError;
                
                // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
                await supabaseClient
                    .from('transactions')
                    .insert({
                        user_id: currentUser.id,
                        type: 'purchase',
                        amount: price,
                        description: `–ü–æ–∫—É–ø–∫–∞ –∫–µ–π—Å–∞: ${caseName}`,
                        status: 'completed'
                    });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                currentUser.balance = newBalance;
                localStorage.setItem('fresko_user', JSON.stringify(currentUser));
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
                updateUserDisplay();
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                document.getElementById('purchaseModal').style.display = 'none';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é —É—Å–ø–µ—à–Ω–æ–π –ø–æ–∫—É–ø–∫–∏
                showNotification(`–ö–µ–π—Å "${caseName}" —É—Å–ø–µ—à–Ω–æ –∫—É–ø–ª–µ–Ω!`, 'success');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–µ–π—Å–æ–≤
                setTimeout(() => loadCases(), 1000);
                
                // –õ–æ–≥–∏—Ä—É–µ–º –ø–æ–∫—É–ø–∫—É
                logUserAction('case_purchase', {
                    case_id: caseId,
                    case_name: caseName,
                    price: price
                });
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏ –∫–µ–π—Å–∞:', error);
                
                // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
                const confirmBtn = document.getElementById('confirmPurchase');
                if (confirmBtn) {
                    confirmBtn.disabled = false;
                    confirmBtn.innerHTML = '<i class="fas fa-check"></i> –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å';
                }
                
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ –∫–µ–π—Å–∞', 'error');
            }
        }

        // ==================== –£–¢–ò–õ–ò–¢–´ ====================

        function updateCountdown(giveawayId, endDate) {
            const timerElement = document.getElementById(`timer-${giveawayId}`);
            if (!timerElement) return 'no-element';
            
            const now = new Date();
            const timeLeft = endDate - now;
            
            if (timeLeft <= 0) {
                timerElement.textContent = '–ó–∞–≤–µ—Ä—à–µ–Ω';
                return 'expired';
            }
            
            const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
            const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
            
            if (days > 0) {
                timerElement.textContent = `${days}–¥ ${hours}—á`;
            } else if (hours > 0) {
                timerElement.textContent = `${hours}—á ${minutes}–º`;
            } else {
                timerElement.textContent = `${minutes}–º ${seconds}—Å`;
            }
            
            return 'active';
        }

        function formatTimeRemaining(endDate) {
            const now = new Date();
            const timeLeft = endDate - now;
            
            if (timeLeft <= 0) return '–ó–∞–≤–µ—Ä—à–µ–Ω';
            
            const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
            const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            
            if (days > 0) {
                return `${days}–¥ ${hours}—á`;
            } else if (hours > 0) {
                const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                return `${hours}—á ${minutes}–º`;
            } else {
                const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
                return `${minutes}–º ${seconds}—Å`;
            }
        }

        function formatCurrency(amount) {
            return parseFloat(amount).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showNotification(message, type = 'info') {
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            const oldNotifications = document.querySelectorAll('.notification');
            oldNotifications.forEach(notif => {
                if (notif.parentElement) {
                    notif.remove();
                }
            });
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'} notification-icon"></i>
                <span>${message}</span>
                <button class="notification-close" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            document.body.appendChild(notification);
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
            
            return notification;
        }

        async function logUserAction(action, details = {}) {
            try {
                await supabaseClient
                    .from('admin_logs')
                    .insert({
                        admin_id: currentUser.id,
                        admin_name: currentUser.username,
                        action: `user_${action}`,
                        details: details,
                        user_agent: navigator.userAgent,
                        created_at: new Date().toISOString()
                    });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏—è:', error);
            }
        }

        function setupAutoRefresh() {
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
            autoRefreshInterval = setInterval(async () => {
                try {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    await loadUserData();
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
                    await loadCategoryData(currentCategory);
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', error);
                }
            }, 30000);
            
            // –û—á–∏—â–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            window.addEventListener('beforeunload', () => {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                }
            });
        }

        async function logout() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) {
                try {
                    // –û—á–∏—â–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª
                    if (autoRefreshInterval) {
                        clearInterval(autoRefreshInterval);
                    }
                    
                    // –í—ã—Ö–æ–¥–∏–º –∏–∑ Supabase
                    await supabaseClient.auth.signOut();
                    
                    // –û—á–∏—â–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                    localStorage.removeItem('fresko_user');
                    localStorage.removeItem('fresko_auth_token');
                    localStorage.removeItem('fresko_refresh_token');
                    
                    // –û—á–∏—â–∞–µ–º —Å–µ—Å—Å–∏–æ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                    if (securitySystem) {
                        securitySystem.destroySession();
                    }
                    
                    // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞
                    window.location.href = 'case-login.html';
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞:', error);
                    showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ', 'error');
                }
            }
        }

        // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ HTML
        window.participateInGiveaway = participateInGiveaway;
        window.openPurchaseModal = openPurchaseModal;
        window.loadGiveaways = loadGiveaways;
        window.loadCases = loadCases;
        window.showNotification = showNotification;

        console.log('‚úÖ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ');
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</body>
</html>
